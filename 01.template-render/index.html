<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Title</title>
</head>
<body>

<div id="root">
  <div class="c1">
    <div class="c2">
      <p>{{name}}--{{msg}}</p>
      <p>{{name}}</p>
      <p>{{msg}}</p>
    </div>
  </div>
  <ul>
    <li>1</li>
    <li>2</li>
    <li>3</li>
  </ul>
</div>

<script>

  /*
  结构：
  class VNode： 虚拟DOM构造函数
  func getVNode： 由HTML DOM --> VNode, 将函数作为一个compiler函数
  func parseVNode：将VNode --> 真实 DOM
  func combine data和VNode结合
  class WZVue 构造

  func getValueByPath 访问对象成员
  * */

  class VNode {
    constructor(tag, data, value, type) {
      this.tag = tag && tag.toLowerCase()
      this.data = data
      this.value = value
      this.type = type
      this.children = []
    }

    appendChild(vnode) {
      this.children.push(vnode)
    }
  }

  function getVNode(node) {
    let _vnode
    const nodeType = node.nodeType
    const attrs = node.attributes
    if (nodeType === 1) { // 元素
      const tag = node.nodeName
      // const value = node.nodeValue
      const attrsObj = {}
      for (let i = 0; i < attrs.length; i++) {
        attrsObj[attrs[i].nodeName] = attrs[i].nodeValue
      }
      _vnode = new VNode(tag, attrsObj, undefined, nodeType)

      // 子节点处理
      const childNodes = node.childNodes
      for (let i = 0; i < childNodes.length; i++) {
        const childNode = childNodes[i]
        _vnode.appendChild(getVNode(childNode))
      }
    } else if (nodeType === 3){
      _vnode = new VNode(undefined, undefined, node.nodeValue, node.nodeType)
    }
    return _vnode

  }

  let r = /\{\{(.+?)\}\}/g;
  //根据路径 访问对象成员
  function getValueByPath(obj, path) {
    let paths = path.split('.'); // [ xxx, yyy, zzz ]
    let res = obj;
    let prop;
    while (prop = paths.shift()) {
      res = res[prop];
    }
    return res;
  }

  //将带有坑的VNode 和 data结合，转为填充数据的VNode，这一步模拟 AST --> VNode
  function combine(vnode, data) {
    let _tag = vnode.tag;
    let _data = vnode.data;
    let _value = vnode.value;
    let _type = vnode.type;
    let _children = vnode.children;

    let _vnode = null;

    if (_type === 3) {//文本节点
      _value = _value.replace(r, (_, g) => {
        return getValueByPath(data, g.trim());
      })
      _vnode = new VNode(_tag, _data, _value, _type);
    } else if (_type === 1) { //元素节点
      _vnode = new VNode(_tag, _data, _value, _type);
      _children.forEach(subVnode => _vnode.appendChild(combine(subVnode, data)));
    }

    return _vnode;
  }

  //将VNode --> 真实 DOM
  function parseVNode(vnode) {
    let type = vnode.type
    let _node = null
    if (type === 3) {
      return document.createTextNode(vnode.value); // 创建文本节点
    } else if (type === 1) {
      _node = document.createElement(vnode.tag);

      // 属性
      let data = vnode.data; // 现在这个 data 是键值对
      Object.keys(data).forEach((key) => {
        let attrName = key;
        let attrValue = data[key];
        _node.setAttribute(attrName, attrValue);
      });

      // 子元素
      let children = vnode.children;
      children.forEach(subVnode => {
        _node.appendChild(parseVNode(subVnode)); // 递归转换子元素 ( 虚拟 DOM )
      });

      return _node;
    }
  }

  class WZVue{
    constructor(options) {
      // 获取实例data
      this._data = options.data
      // 获取实例dom
      this._template = options.el && document.querySelector(options.el)
      // 获取实例dom的父节点
      this._parent = this._template.parentNode

      // 渲染
      this.mount()
    }
    //提供一个方法，生成虚拟DOM
    mount() {
      this.render = this.createRender();
      this.mountComponent();
    }

    // 执行 mountComponent() 函数
    mountComponent() {
      let mount = () => {
        this.update(this.render());
      }
      mount.call(this); // 本质应该交给 watcher 来调用
    }

    //生成render函数, 目的是缓存抽象语法树
    createRender() {
      let ast = getVNode(this._template);
      console.log(ast, 'ssss')
      //将 AST + data => VNode
      //带有坑的 VNode + data => 含有数据的 VNode
      return function render() {
        // 将 带有 坑的 VNode 转换为 待数据的 VNode
        let _tmp = combine(ast, this._data);
        return _tmp;
      }
    }

    //直接生成真实DOM替换页面中
    update(vnode) {
      let realDom = parseVNode(vnode);
      this._parent.replaceChild(realDom, document.querySelector('#root'));
    }
  }

  let app = new WZVue({
    el: '#root',
    data: {
      name: 'Wang Zhen',
      msg: 'msg data'
    }
  });

</script>
</body>
</html>
